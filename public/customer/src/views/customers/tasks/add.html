<title>优化任务</title>

<div class="layui-card layadmin-header">
    <div class="layui-breadcrumb" lay-filter="breadcrumb">
        <a lay-href="">主页</a>
        <a><cite>SEO管理</cite></a>
        <a><cite>优化任务</cite></a>
    </div>
</div>



<div class="layui-fluid">
    <div class="layui-row layui-col-space15">

        <div class="layui-col-md12">
            <div class="layui-card">
                <div class="layui-form layui-card-header layuiadmin-card-header-auto" lay-filter="app-content-list">
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">关键字</label>
                            <div class="layui-input-inline">
                                <input type="text" name="keywords" placeholder="可搜索关键字、网址" autocomplete="off" class="layui-input">
                            </div>
                        </div>
                        <!-- <div class="layui-inline">
                            <label class="layui-form-label">网址</label>
                            <div class="layui-input-inline">
                                <input type="text" name="url" placeholder="请输入网址" autocomplete="off" class="layui-input">
                            </div>
                        </div> -->
                        
                        <div id="view" class="layui-inline">
        
                        </div>
                        <script id="ngines_select" type="text/html">
                            <label class="layui-form-label">{{ d.title }}</label>
                            <div class="layui-input-inline">
                                    <select name="search_ngines" lay-verify="search_ngines">
                                        <option value="">全部</option>
                                        {{#  layui.each(d.list, function(index, item){ }}
                                            <option value="{{index}}">{{item}}</option>
                                        {{#  }); }}
                                        
                                    </select>
                                
                            </div>
                        </script>
                        <div class="layui-inline">
                            <button class="layui-btn layuiadmin-btn-list" lay-submit lay-filter="LAY-app-contlist-search">
                                <i class="layui-icon layui-icon-search layuiadmin-button-btn"></i>查询
                            </button>
                        </div>
                    </div>
                </div>
                <div class="layui-card-body" style="overflow: hidden;">
                    <div style="padding-bottom: 10px;">
                        
                        <button class="layui-btn layuiadmin-btn-list" data-type="addquick"><i class="layui-icon layui-icon-add-circle-fine"></i>快速站外优化</button>
                        <button class="layui-btn layuiadmin-btn-list" data-type="add"><i class="layui-icon layui-icon-add-circle-fine"></i>添加常规优化</button>
                        <button class="layui-btn layuiadmin-btn-list" data-type="batSubmit">批量提交</button>
						<button class="layui-btn layuiadmin-btn-list" data-type="del"><i class="layui-icon layui-icon-delete"></i>删除</button>
                        <!-- <button class="layui-btn layuiadmin-btn-list" data-type="inquiry"><i class="layui-icon layui-icon-search"></i>价格查询</button> -->
                       <!-- <button class="layui-btn layuiadmin-btn-list" data-type="delAll"><i class="layui-icon layui-icon-fonts-del"></i>清空</button> -->


                    </div>

                    <blockquote class="layui-elem-quote">
                        <p>常规优化：正常优化方式，站内、站外都会优化，支持新站，请务必添加 后台及FTP，
                            否则因此不能及时调整站内导致的无法优化、优化进度不能正常进行的一切后果自行承担。合作周期至少三个月，否则可能不通过审核。</p>
                        <p>站外优化：优化方式为纯站外优化，可以7-30天快速上首页，要求网站关键词已经在搜索引擎前十页，否则优化会有很大几率失败。</p>
                        <p style="color: red;">关键词更新：请提交关键词后点击刷新更新排名。</p>
                    </blockquote>
                    <!--<div class="layui-tab layui-tab-card">-->
                        <!--<ul class="layui-tab-title">-->
                            <!--<li class="layui-this">待审核</li>-->
                            <!--<li>被拒绝</li>-->
                            <!--<li>权限分配</li>-->
                            <!--<li>商品管理</li>-->
                            <!--<li>订单管理</li>-->
                        <!--</ul>-->

                    <!--</div>-->
                    <div class="layui-col-md12">
                        <div class="layui-col-xs9">
                            <table id="LAY-app-seo-list" class="layui-form" lay-filter="LAY-app-seo-list"></table>
                        </div>
                        <style>
                            .layui-card-body{overflow: hidden;}
                            .layui-card .layui-col-xs6{    padding: 0 0.75rem;height: 36px;line-height: 36px;}
                            .right-align{text-align: right;font-size: 15px;font-weight: 600;}
                            .left-align{text-align: left;}
                            .deploy_title {
                                padding-left: 30px;
                                font-size: 18px;
                                line-height: 40px;
                                color: #fff;
                                background-color: #26a69a;
                            }
                            #dbmt_money,#dj_money{    font-size: 20px; color: #f80;}
                            .layui-col-xs6 a{    color: #26a69a;}
                        </style>
                        <div class="layui-col-xs3">
                            <div class="layui-card">
                                <div class="layui-card-header "><h4 class="deploy_title">已选择的关键词配置</h4></div>
                                <div class="layui-card-body">
                                    <div class="layui-col-xs6 right-align">站外优化周期：</div>
                                    <div class="layui-col-xs6 ">约7-20天</div>
                                    <div class="layui-col-xs6 right-align">常规优化周期：</div>
                                    <div class="layui-col-xs6">约30-60天</div>
                                    <div class="layui-col-xs6 right-align">系统计费方式：</div>
                                    <div class="layui-col-xs6">按天扣费</div>
                                    <div class="layui-col-xs6 right-align">勾选关键词数：</div>
                                    <div class="layui-col-xs6"><span id="dbmt_number">0</span></div>
                                    <div class="layui-col-xs6 right-align">达标每日消费：</div>
                                    <div class="layui-col-xs6"><span id="dbmt_money">￥0.00</span></div>
                                    <div class="layui-col-xs6 right-align">任务合计总价：</div>
                                    <div class="layui-col-xs6"><span id="dj_money">￥0.00</span></div>
                                    <div class="layui-col-xs6 right-align">
                                        <div class="layui-input-inline">
                                            <input type="checkbox" name="check" value="1" title="阅读" checked="">
                                        </div>
                                        我已阅读并同意：
                                    </div>
                                    <div class="layui-col-xs6"><a href="javascript:void(0);">《网站SEO优化协议》</a></div>
                                    <button class="layui-btn layuiadmin-btn-list layui-btn-fluid layui-btn-warm" data-type="batSubmit">购买当前关键词</button>
                                </div>

                            </div>
                        </div>
                    </div>

                    
                    <script type="text/html" id="rankTpl">
                        {{#  if(d.status==2 || d.status==3){ }}
                                {{# if(d.current_ranking==0){ }}
                                    >100
                                {{#  } else { }}
                                    {{d.current_ranking}}
                                {{#  } }}
                        {{#  } else { }}
                                --
                        {{#  } }}
                    </script>
                    <script type="text/html" id="originalrankTpl">
                        {{#  if(d.original_rank == 101){ }}
                                {{# if(d.rank_time){ }}
                                    >100
                                {{#  } else { }}
                                    <i class="layui-icon layui-icon-loading layui-icon layui-anim layui-anim-rotate layui-anim-loop"></i>
                                {{#  } }}
                        {{#  } else { }}
                                {{ d.original_rank }}
                        {{#  } }}
                    </script>
                    <script type="text/html" id="buttonTpl">
                        {{#  if(d.status == 0) { }}
                                <span style="color: red;">未提交</span>
                        {{#  } else if(d.status == 1) { }}
                                <span style="color:#0da919;">审核中</span>
                        {{#  } else if(d.status == 2) { }}
                                <span style="color:#0da919;">任务进行中</span>
                        {{#  } else if(d.status == 3) { }}
                                <span style="color:#0da919;">已完成</span>
                        {{#  } else if(d.status == 5) { }}
                                <span style="color:#0da919;">审核未通过</span>
                        {{#  } }}
                    </script>
                    <script type="text/html" id="button-content">
                        <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="edit" title="编辑"><i
                            class="layui-icon layui-icon-edit"></i></a>
                        {{#  if(d.status == 0 ){ }}
                            <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="submits" title="提交"><i
                            class="layui-icon layui-icon-ok"></i></a>
                            
                            <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="update" title="更新"><i
                            class="layui-icon layui-icon-refresh"></i></a>
                            <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="delete" title="删除"><i
                            class="layui-icon layui-icon-delete"></i></a>
                        {{#  } else if(d.status == 5) { }}
                            <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="submits" title="重新提交"><i
                            class="layui-icon layui-icon-ok"></i></a>
                            
                            <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="delete" title="删除"><i
                            class="layui-icon layui-icon-delete"></i></a>
                        {{#  } }}
                    </script>
                    <script type="text/html" id="originalrankTpl">
                        {{#  if(d.original_rank == 0){ }}
                                (更新中)
                        {{#  } else { }}
                                {{ d.original_rank }}
                        {{#  } }}
                    </script>
                </div>
            </div>
        </div>
        <!--<div class="layui-col-md4">-->
            <!--<div class="layui-card">-->
                <!--<div class="layui-card-header">-->
                    <!--已选择的关键词配置-->
                <!--</div>-->
                <!--<div class="layui-card-body">-->
                    <!--<div id="checkbox"></div>-->
                    <!--<div style="clear: both;"></div>-->
                <!--</div>-->
            <!--</div>-->
        <!--</div>-->
    </div>
</div>
<script type="text/javascript">
layui.use(['admin','table','form','setter'],function () {

    var table = layui.table
        ,view = layui.view
        ,admin = layui.admin
        ,form = layui.form
        ,setter = layui.setter
        ,laytpl = layui.laytpl
        ,request = setter.request
        ,$ = layui.$;
    form.render(null, 'app-content-list');
    var keywrodTab = table.render({
        elem:"#LAY-app-seo-list"
        ,url: '/v1/task/list?status=0&shenhe_status=0' //模拟接口
        ,headers:{
           'access-token':(layui.data(setter.tableName)[request.tokenName] || '')
        }
        ,cols: [[
            {type: 'checkbox', fixed: 'left'}
            ,{field: 'keywords', title: '关键词'}
            ,{field: 'price', title: '价格/天'}
            ,{field: 'web_url', title: '网址',width:150,align:'center'}
            ,{field: 'search_ngines', title: '搜索引擎'}
            ,{field: 'create_time', title: '提交时间',sort:true}
            ,{field: 'original_rank', title: '初始排名', align:'center', templet:'#originalrankTpl',sort:true}
            ,{field: 'current_ranking', title: '当前排名', align:'center', templet:'#rankTpl',sort:true}
            ,{field: 'status', title: '状态', templet: '#buttonTpl', Width: 60, align: 'center',fixed: 'right',}
            ,{field: 'cycle', title: '合作周期',templet:function (d ) {
                    return  d.cycle + "天";
                },sort:true}
            // ,{field: 'status', title: '审核状态'}
            ,{title: '操作', minWidth: 200, align: 'center', fixed: 'right', templet: '#button-content'}
        ]]
        ,parseData:function ( res ) {
            return {
                "code": res.code, //解析接口状态
                "msg": res.msg, //解析提示文本
                "count": res.data.total, //解析数据长度
                "data": res.data.data //解析数据列表
            };
        }
        ,loading:true
        ,page: true
        ,limit: 20
        ,limits: [30, 50, 100, 200, 500]
        ,text:{none: '一条数据也没有^_^'}
    });


    form.on('checkbox', function(data){
        
        setTimeout(function(){
            var checkStatus = table.checkStatus('LAY-app-seo-list')
                    ,checkData = checkStatus.data; //得到选中的数据
            var dbmt_money = 0;
            var dj_money = 0;
            for (var i=0;i<checkData.length;i++){
                dbmt_money += parseFloat(checkData[i].price);
                dj_money += parseFloat(checkData[i].price) * parseFloat(checkData[i].cycle);
                
            }
            $("#dbmt_number").html(checkData.length);
            $("#dbmt_money").html("￥"+dbmt_money.toFixed(2));
            $("#dj_money").html("￥"+dj_money.toFixed(2));
            
            
        },1)
        


        // console.log(data.elem); //得到checkbox原始DOM对象
        // console.log(data.elem.checked); //是否被选中，true或者false
        // console.log(data.value); //复选框value值，也可以通过data.elem.value得到
        // console.log(data.othis); //得到美化后的DOM对象
    });
    //监听搜索
    form.on('submit(LAY-app-contlist-search)', function (data) {
        var field = data.field;

        //执行重载
        table.reload('LAY-app-seo-list', {
            where: field
        });
    });
        
    
    table.on('tool(LAY-app-seo-list)',function (obj) {
        var data = obj.data;
        if(obj.event == "add"){
            layer.confirm('确定提交吗？', function(index) {
                admin.req({
                    url: '/v1/order/add' //实际使用请改成服务端真实接口
                    ,type:'post'
                    ,data: {tid:data.id}
                    ,done: function( res ){
                        //请求成功后，写入 access_token
                        //登入成功的提示与跳转
                        layer.msg('操作成功', {
                            offset: '15px'
                            ,icon: 1
                            ,time: 1000
                        }, function(){
                            keywrodTab.reload('LAY-app-seo-list');
                        });
                    }
                });

            });
        }else if(obj.event == "submits"){
            layer.confirm('确定提交吗？', function(index) {
                admin.req({
                    url: '/v1/keyword/submit' //实际使用请改成服务端真实接口
                    ,type:'post'
                    ,data: {tid:data.id}
                    ,done: function( res ){
                        //请求成功后，写入 access_token
                        //登入成功的提示与跳转
                        if (!res.id) {
                            layer.msg('操作成功', {
                                offset: '15px'
                                ,icon: 1
                                ,time: 1000
                            }, function(){
                                table.reload('LAY-app-seo-list');
                            });
                        }
                        
                    }
                });

            });
        }else if(obj.event == "update"){
            admin.req({
                url: '/v1/keyword/update' //实际使用请改成服务端真实接口
                ,type:'post'
                ,data: {tid:data.id}
                ,done: function( res ){
                    
                    
                    layer.msg(res.msg, {
                        offset: '15px'
                        ,icon: 1
                        ,time: 1000
                    }, function(){
                        keywrodTab.reload('LAY-app-query-ranking-list');
                    });
                    
                }
            });
        }else if(obj.event == "delete"){
            layer.confirm('确定删除吗？', function(index) {
                admin.req({
                    url: '/v1/keyword/del' //实际使用请改成服务端真实接口
                    ,type:'post'
                    ,data: {tid:data.id,ids:data.id}
                    ,done: function( res ){
                        //请求成功后，写入 access_token
                        //登入成功的提示与跳转
                        if (!res.id) {
                            layer.msg('操作成功', {
                                offset: '15px'
                                ,icon: 1
                                ,time: 1000
                            }, function(){
                                table.reload('LAY-app-seo-list');
                            });
                        }
                        
                    }
                });

            });
        }else if(obj.event == "edit"){
            admin.popup({
                title: '编辑'
                ,area: ['800px', '460px']
                ,id: 'LAY-popup-content-info'
                ,btn:['修改','关闭']
                ,success: function(layero, index){
                    
                    view(this.id).render('customers/tasks/edit-form', data).done(function(){
                        form.render(null, 'layuiadmin-app-form-list');
                    });
                }
                ,yes:function (index, layero) {
                    var keywords = $("input[name='keywordse']").val();
                    var web_url = $("input[name='web_url']").val();
                    var xiongzhang = $("input[name='xiongzhang']").val();
                    var cycle = $("input[name='cycle']").val();
                    
                    
                    admin.req({
                        url: '/v1/keyword/edit'
                        ,type:"post"
                        ,data:{id:data.id,keywords:keywords,web_url:web_url,xiongzhang:xiongzhang,cycle:cycle}
                        ,done: function( res ){
                            layer.msg(res.msg, {
                                offset: '15px'
                                ,icon: 1
                                ,time: 1000
                            },function () {
                                layui.table.reload('LAY-app-seo-list'); //重载表格
                                layer.close(index); //执行关闭
                            });
                        }
                    });
                }
                ,btn2: function(index, layero){
                    layer.close(index); //执行关闭
                }
            });
        }
    })
    var active = {
        del: function () {
            var checkStatus = table.checkStatus('LAY-app-seo-list')
                , checkData = checkStatus.data; //得到选中的数据

            if (checkData.length === 0) {
                return layer.msg('请选择数据');
            }

            var _ids=[];
            for (var i=0;i<checkData.length;i++){
                _ids.push(checkData[i].id);
            }
            layer.confirm('确定删除吗？', function(index) {

                //执行 Ajax 后重载

                admin.req({
                    url: '/v1/keyword/del.html'
                    ,type:"post"
                    ,data: {ids:_ids}
                    ,done: function( res ){
                        //登入成功的提示与跳转
                        layer.msg('删除成功', {
                            offset: '15px'
                            ,icon: 1
                            ,time: 1000
                        }, function(){
                            keywrodTab.reload('LAY-app-query-ranking-list');
                            //  location.hash = search.redirect ? decodeURIComponent(search.redirect) : '/';
                        });
                    }
                });


               // layer.msg('已删除');
            });
        }
        ,delAll:function () {
            layer.confirm('确定删除所有吗？', function(index) {

                //执行 Ajax 后重载

                admin.req({
                    url: '/v1/keyword/del.html'
                    ,type:"post"
                    ,data: {isdel:1}
                    ,done: function( res ){
                        //登入成功的提示与跳转
                        layer.msg('删除成功', {
                            offset: '15px'
                            ,icon: 1
                            ,time: 1000
                        }, function(){
                            keywrodTab.reload('LAY-app-query-ranking-list');
                            //  location.hash = search.redirect ? decodeURIComponent(search.redirect) : '/';
                        });
                    }
                });


                // layer.msg('已删除');
            });
        }
        //快速添加
        , addquick: function (othis) {
            admin.popup({
                title: '快速添加'
                , area: ['800px', '600px']
                , id: 'LAY-popup-content-add'
                , success: function (layero, index) {
                    view(this.id).render('customers/tasks/add-form-quick').done(function () {
                        form.render(null, 'layuiadmin-app-task-add');

                        //监听提交
                        form.on('submit(layuiadmin-app-task-submit)', function (data) {
                            var field = data.field; //获取提交的字段
                                 field.keywords = field.keywords.replace(/\n/g,"|");
                            var index = layer.msg('处理中...',{shade:[0.8, '#393D49'],time:60*60*1000});
                            admin.req({
                                url: '/v1/keyword/addquick.html' //实际使用请改成服务端真实接口
                                ,type:'post'
                                ,data: field
                                ,done: function( res ){
                                    //请求成功后，写入 access_token

                                    //登入成功的提示与跳转
                                    layer.msg('添加成功', {
                                        offset: '15px'
                                        ,icon: 1
                                        ,time: 1000
                                    }, function(){
                                        //window.location.reload();
                                        layer.closeAll(); //执行关闭
                                        keywrodTab.reload('LAY-app-seo-list');
                                        if(res.id)  //添加成功后异步更新一次
                                        {
                                            admin.req({
                                                url: '/v1/keyword/update' 
                                                ,type:'post'
                                                ,data: {tid:0,action:'bat'}
                                                ,done: function( res ){
                                                    
                                                   keywrodTab.reload('LAY-app-seo-list');
                                                }
                                            });
                                            
                                        }
                                        
                                        //keywrodTab.reload('LAY-app-seo-list');
                                        //layer.close(index); //执行关闭;
                                    });
                                },
                                success:function(){
                                    layer.close(index);
                                }
                            });

                        });
                    });
                }
            });
        },add: function (othis) {
            admin.popup({
                title: '添加常规优化'
                , area: ['800px', '600px']
                , id: 'LAY-popup-content-add'
                , success: function (layero, index) {
                    view(this.id).render('customers/tasks/add-form').done(function () {
                        form.render(null, 'layuiadmin-app-task-add');

                        //监听提交
                        form.on('submit(layuiadmin-app-task-submit)', function (data) {
                            var field = data.field; //获取提交的字段
                                 field.keywords = field.keywords.replace(/\n/g,"|");
                            layer.msg('处理中...',{shade:[0.8, '#393D49'],time:60*60*1000});
                            admin.req({
                                url: '/v1/keyword/add.html' //实际使用请改成服务端真实接口
                                ,type:'post'
                                ,data: field
                                ,done: function( res ){
                                    //请求成功后，写入 access_token

                                    //登入成功的提示与跳转
                                    layer.msg('添加成功', {
                                        offset: '15px'
                                        ,icon: 1
                                        ,time: 1000
                                    }, function(){
                                        keywrodTab.reload('LAY-app-seo-list');
                                        layer.closeAll();//执行关闭
                                        if(res.id)  //添加成功后异步更新一次
                                        {
                                            admin.req({
                                                url: '/v1/keyword/update' 
                                                ,type:'post'
                                                ,data: {tid:0,action:'bat'}
                                                ,done: function( res ){
                                                    
                                                   keywrodTab.reload('LAY-app-seo-list');
                                                }
                                            });
                                            
                                        }
                                    });
                                },
                                success:function(){
                                    layer.close(index);
                                }
                            });

                        });
                    });
                }
            });
        },inquiry: function (othis) {
            admin.popup({
                title: '价格查询'
                , area: ['500px', '500px']
                , id: 'LAY-popup-content-inquiry'
                ,btn:['查询','关闭']
                , success: function (layero, index) {
                    view(this.id).render('customers/tasks/inquiry-form').done(function () {
                        form.render(null, 'layuiadmin-app-task-add');
                    });
                }
                ,yes:function (index, layero) {
                    var keywords = $("#layuiadmin-app-task-add input[name='inquiry_keywords']").val();
                    var web_url = $("#layuiadmin-app-task-add input[name='inquiry_web_url']").val();
                    var search_ngines = $("#layuiadmin-app-task-add select[name='search_ngines']").val();
                    console.log(keywords);
                    admin.req({
                        url: '/v1/keyword/inquiry.html'
                        ,type:"post"
                        ,data:{keywords:keywords,web_url:web_url,search_ngines:search_ngines}
                        ,done: function( res ){
                            layer.alert('关键词“'+keywords+'”优化价格为'+res.data.price+'/天')
                            
                        }
                    });
                }
                ,btn2: function(index, layero){
                    layer.close(index); //执行关闭
                }
            });
        },batSubmit:function(){
                var checkStatus = table.checkStatus('LAY-app-seo-list')
                    ,checkData = checkStatus.data; //得到选中的数据
                var ischeck =false;
                $("input:checkbox[name='check']:checked").each(function(i){
                    
                    if($(this).val() == 1){
                        ischeck = true;
                    }
                });

                if(!ischeck)
                {
                    return layer.msg('请阅读并接受《网站SEO优化协议》');
                }
                if(checkData.length === 0){
                    return layer.msg('请选择关键词');
                }
                var _ids=[];
                for (var i=0;i<checkData.length;i++){
                    _ids.push(checkData[i].id);
                }
                layer.confirm('确定批量提交吗？', function(index) {

                    //执行 Ajax 后重载

                    admin.req({
                      url: '/v1/keyword/batchsubmit'
                        ,type:"post"
                        ,data: {ids:_ids}
                        ,done: function( res ){
                            //登入成功的提示与跳转
                            layer.msg('操作成功', {
                                offset: '15px'
                                ,icon: 1
                                ,time: 1000
                            }, function(){
                                table.reload('LAY-app-seo-list');
                            });
                        }
                    });

                    
                });
            }
    };

    $('.layui-btn.layuiadmin-btn-list').on('click', function () {
        var type = $(this).data('type');
        active[type] ? active[type].call(this) : '';
    });

    var data = { //数据
      "title":"搜索引擎"
      ,"list":setter.search_ngines
    }
    var getTpl = ngines_select.innerHTML
    ,viewxxx = document.getElementById('view');
    laytpl(getTpl).render(data, function(html){
      viewxxx.innerHTML = html;
    });
    form.render(null, 'app-content-list');

    $(document).on('click','.countreduce',function(){
        var min = 3;
        var value = parseInt($("input[name='cycle']").val());
        if( (value-1) >=min)
        {
            $("input[name='cycle']").val(value-1);
        }else {
            layer.msg('合作周期最少'+min+'个月');
        }
    });
    $(document).on('click','.countadd',function(){
        var value = parseInt($("input[name='cycle']").val());
        $("input[name='cycle']").val( value+1 );
    });


})

</script>